<?xml version="1.0" encoding="UTF-8"?>
<project name="guzzle" default="package">
    <!-- set local values, like git location -->
    <property file="phing/build.properties" override="true" />
    
    <property name="dir.output" value="${project.basedir}/build/artifacts" />
    <property name="dir.imports" value="${project.basedir}/phing/imports" />
    <property name="dir.bin" value="${project.basedir}/bin" />
    <property name="repo.dir" value="${project.basedir}" />
    
    <import file="${dir.imports}/dependencies.xml"/>
    <import file="${dir.imports}/test.xml"/>
    <import file="${dir.imports}/deploy.xml"/>
    <!-- <import file="${dir.imports}/metrics.xml"/> -->
    

    <target name="test" description="Run unit tests" depends="test-init">
        <exec passthru="true" command="phpunit" />
        <testserver cmd="${cmd.testserver}" action="stop" />
    </target>

    <target name="test-init" depends="install-dependencies" description="Initialize test dependencies">
        <testserver cmd="${cmd.testserver}" action="start" />
        <copy file="phpunit.xml.dist" tofile="phpunit.xml" overwrite="false" />
    </target>

    <target name="build-init" description="Initialize local phing properties">
        <copy file="phing/build.properties.dist" tofile="phing/build.properties" overwrite="false" />
    </target>

    <target name="clean">
        <delete dir="${dir.output}"/>
    </target>

    <target name="prepare" depends="clean,test-init,build-init">
        <mkdir dir="${dir.output}"/>
        <mkdir dir="${dir.output}/logs" />
    </target>

    <target name="coverage" depends="prepare">
        <exec passthru="true" command="phpunit --coverage-html=${dir.output}/coverage --coverage-clover=${dir.output}/logs/clover.xml" />
    </target>

    <target name="view-coverage">
        <exec passthru="true" command="open ${dir.output}/coverage/index.html" />
    </target>

    <target name="package" depends="test-init" description="Create a phar with an autoloader">
        <pharpackage
            destfile="${dir.output}/guzzle.phar"
            basedir="."
            stub="phar-stub.php"
            signature="md5">
            <fileset dir=".">
                <include name="src/**/*.php" />
                <include name="vendor/symfony/class-loader/Symfony/Component/ClassLoader/UniversalClassLoader.php" />
                <include name="vendor/symfony/event-dispatcher/**/*.php" />
                <include name="vendor/doctrine/common/lib/Doctrine/Common/Cache/*.php" />
                <include name="vendor/monolog/monolog/src/**/*.php" />
            </fileset>
            <metadata>
                <element name="author" value="Michael Dowling" />
            </metadata>
        </pharpackage>
        <exec command="php -d guzzle_phar=${dir.output}/guzzle.phar `which phpunit`" passthru="true" />
    </target>

    <target name="package-min" depends="test-init" description="Create a minimal phar">
        <pharpackage
                destfile="${dir.output}/guzzle-min.phar"
                basedir="."
                stub="phar-stub-min.php"
                signature="md5">
            <fileset dir=".">
                <include name="src/**/*.php" />
            </fileset>
            <metadata>
                <element name="author" value="Michael Dowling" />
            </metadata>
        </pharpackage>
        <exec command="php -d guzzle_phar=${dir.output}/guzzle-min.phar `which phpunit`" passthru="true" />
    </target>
</project>