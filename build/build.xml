<?xml version="1.0" encoding="UTF-8"?>

<project name="guzzle" default="init">

    <target name="init-git" description="Initialize git submodules">
        <echo msg="Initializing git submodules" />
        <exec command="git submodule update --init" dir="./.." />
    </target>

    <target name="init-test" description="Initialize for unit testing">
        <echo msg="Copying ./phpunit.xml.dist to ./phpunit.xml" />
        <copy file="../phpunit.xml.dist" tofile="../phpunit.xml" />
    </target>

    <target name="init" depends="init-git,init-test" />

    <target name="phar" description="Create a phar with an autoloader">
        <pharpackage
            destfile="./guzzle.phar"
            basedir="../src"
            stub="./autoload.php"
            alias="Guzzle"
            signature="sha1">
            <fileset dir="../src">
                <include name="**/*.php" />
                <exclude name="**/Tests/**" />
            </fileset>
            <metadata>
                <element name="version" value="1.0.1" />
            </metadata>
        </pharpackage>
    </target>

    <target name="phar-na" description="Create a phar with no autoloader">
        <pharpackage
            destfile="./guzzle-na.phar"
            basedir="../src"
            alias="Guzzle"
            signature="sha1">
            <fileset dir="../src">
                <include name="**/*.php" />
                <exclude name="**/Tests/**" />
            </fileset>
            <metadata>
                <element name="version" value="1.0.1" />
            </metadata>
        </pharpackage>
    </target>

    <target name="service" description="Clone a Guzzle service">
        <fail unless="repo" message="You must specify the URL to a git repository" />
        <fail unless="path" message="You must specify the path to clone the repository" />
        <property name="exists" value="0" />
        <available file="../${path}" type="dir" property="exists" value="1"/>
        <if>
            <equals arg1="${exists}" arg2="0" />
            <then>
                <exec passthru="true" command="git clone ${repo} ${path}" dir="../" checkreturn="true" />
            </then>
            <else>
                <exec passthru="true" command="git fetch origin" dir="../${path}" checkreturn="true" />
                <exec passthru="true" command="git reset --hard" dir="../${path}" checkreturn="true" />
            </else>
        </if>
    </target>

    <target name="all-services" description="Clone all known Guzzle services">
        <phingcall target="service">
            <property name="repo" value="git://github.com/guzzle/guzzle-aws.git" />
            <property name="path" value="./src/Guzzle/Aws" />
        </phingcall>
        <phingcall target="service">
            <property name="repo" value="git://github.com/guzzle/guzzle-cardinal-commerce.git" />
            <property name="path" value="./src/Guzzle/CardinalCommerce" />
        </phingcall>
        <phingcall target="service">
            <property name="repo" value="git://github.com/guzzle/guzzle-unfuddle.git" />
            <property name="path" value="./src/Guzzle/Unfuddle" />
        </phingcall>
    </target>

    <target name="template" description="Create a client project skeleton">
        <input propertyname="service.path" promptChar=":">Enter the path where you want to install your web service client</input>
        <input propertyname="service.short_name" promptChar=":">Enter the short name of your client (e.g. guzzle-aws)</input>
        <input propertyname="service.client_class" promptChar=":">Enter the name of your client class (e.g. UnfuddleClient)</input>
        <input propertyname="service.namespace" promptChar=":">Enter the root namespace of your client (e.g. Guzzle\Aws)</input>

        <echo msg="Creating web service client project" />

        <fileset id="skeleton" dir="./template">
            <include name="**/**"/>
        </fileset>

        <echo msg="Creating folder for project at ${service.path}" />
        <mkdir dir="${service.path}" />

        <echo msg="Copying files to folder" />
        <copy todir="${service.path}" overwrite="true">
            <fileset refid="skeleton" />
            <filterchain>
                <expandproperties />
            </filterchain>
        </copy>

        <move file="${service.path}/Client.php" toFile="${service.path}/${service.client_class}.php" />
    </target>
</project>